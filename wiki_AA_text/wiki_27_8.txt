Z80
Z80 は、米国ザイログによって製造された 8ビット・マイクロプロセッサーである。1976年に発表され、1980年代の中頃までは、パーソナルコンピューターのCPUとしてなど、幅広い用途に使用された。以後も周辺デバイスを集積した製品が出されるなど、現在でも組み込み用途など、目に見えないところで多用されている。
嶋正利らインテルを退社したIntel 8080の開発スタッフが設計を行っており、8080とはバイナリレベルでほぼ上位互換性がある（100%ではない）。
ザイログオリジナルの製品としてクロック周波数が2.5MHzのZ80から20MHzの派生製品まで、各社からセカンドソースや互換製品が製造されている。2007年現在は実チップではなく、FPGAやASIC用のIPコアとして活用されている。パチンコの主基板向けプロセッサーに使われているNECのμPD70008 IPをはじめ、商用の互換コアは20社以上存在し、オープンソースのIPコアも5種類以上存在している。
Z80とその互換CPUは、当初はより高速な8080互換CPUとして応用され、S-100バス互換機にもこぞって搭載されるなど、黎明期のパーソナルコンピューター市場を支配した。日本国内においても、1970年代の末から80年代前半頃にかけて、ビジネス用のオフィスコンピュータなどの他、各社のホビーパソコンにも搭載された。
また組み込み用としては21世紀に至るまで応用され続けて来ており、多数の機器に搭載されたほか、初期のゲーム専用機などにも搭載されていた。パチンコ・パチスロの抽選を司る主基板部分のコアCPUには暗号機能を付与したZ80ベースのカスタムLSIが使われており、消費量の多い分野の一つである。このLSIはCPUとメモリーの間で交換するデータを暗号化し、プローブを当ててもプログラムやデータが読み取れない様にしている。
8080が、それと組み合わせられる8251 (USART)、8253 (CTC / PIT)、8255（PPI）でファミリーを構成していたのに対応して、Z80SIO、Z80CTC、Z80PIOや、Z80DMAでZ-80ファミリーを構成する。また、これらを組み合わせたマイコンがある。
開発者の間では、しばしば「ゼッぱち」と略して呼ばれることが多い。しかし、同社にはZ8というマイクロコントローラーもあるため、混乱の原因になることもある。
Z80は、インテルの 8080マイクロプロセッサの改良型といえる製品であり、他のインテル系CPUと同じくリトルエンディアンである。8080に対して、若干の拡張、電源の 5V単一化、より高いクロック周波数への対応などが図られた。メモリー空間は16ビット幅のアドレスバスで示される64KBで、それ以上のメモリー空間を操作する場合には、MMUなどを追加しバンク切り替えなどを行う必要がある。
最大クロック周波数は、Z80が2.5MHz版、Z80Aが4MHz版、Z80Bが6MHz版、Z80EもしくはZ80Hが8MHz版、など、末尾のアルファベットの有無と種類で識別できる。トランジスター数は8,200個。CMOS版ではZ84C0006が6.17MHz、Z84C0008が8MHz、Z84C0010が10MHz、Z84C0020が20MHz動作となっている。
8080から拡張されているものは、DRAMの情報を維持（リフレッシュ）する機能の内蔵とそのためのレジスタの追加、8080では1組だった汎用レジスター群を、切り替えて使用できる表と裏の2組とし、また、IXとIYの2つのインデックスレジスタを使用したメモリー操作を含む命令の増強、割り込みモードの追加、ワイヤードロジックによる命令の実行、などが行われている。乗算・除算命令は8080同様に存在しない。
また、本来16ビット固定のインデックスレジスタを8ビット単位に分割して使用できるなど、ロジックの設計上で派生したとおぼしき、命令表には存在しない隠し命令が存在した。これらの一部はZ280のマニュアル中で正式にドキュメント化されている。
製造には、この頃使われ初めたイオン打ち込み技術が使われた。当時、ライセンスを取ってセカンドソースとして製造する、あるいはクリーンルーム設計による独立実装ではなく、顕微鏡写真を利用したデッドコピーを行う一部の日本企業があったため、イオン打ち込み技術はその対策のためにも使われた。イオン打ち込みにより、エンハンスメント（ノーマリーオフ）に見えるが実はディプリーション（ノーマリーオン）というトランジスタを6個ほど仕組み、素直にデッドコピーしたのでは正しく動作しなくなるようにして時間稼ぎをした。
8080に存在する命令については、同じバイナリとなるという、基本的は上位互換である。しかし、フラグ変化の違いがあるため、プログラムをバイナリ的にそのままもってきても動かないという可能性はありうる（あまり使われないフラグであるパリティフラグなので、それを使っていなければ動く）。
（以下の記述は命令セットではなく、アセンブラの実装の話で、アセンブラの設計者によりどのようにも変えられるものであり、またどのアセンブラのことを言ってるのかよくわからないが）ニモニックは、8080に対応する命令があるものでもインテル版とザイログ版では全く異なっており、記述の容易さが勘案され、より整理されたものとなった。これは初心者にも判りやすいとされる反面、他のCPUのニモニックと比較して、アドレッシングモードがはっきりしない、という欠点もあった。オペランドの順番は、ディスティネーションが前でソースが後である。
8080との差別化のため、命令の1サイクル目（M1サイクル）では他のサイクルに比べて所要ステート数が少なくなっている。通常のサイクルが3ステート必要なのに対しM1サイクルでは2ステートである。仕様を見るとM1サイクルには4ステート必要なように見えるが、後半の2ステートはリフレッシュ機能のために使用され、通常のメモリーアクセスとは関係がない。
これは同じ命令を実行しても8080よりも高速に実行するためのZ80の売りの一つだった。反面、このM1サイクルだけのために速いメモリーが必要になり、ハードウェア設計者からは不評を買っていた。
Z80には「特定の命令の組み合わせを用いると、普通に命令を書いた場合よりも実行にかかるクロック数や命令の総バイト数を少なくできる」というテクニックが多数存在し、これらは「最適化」「クロック削り」などと呼ばれた。例えば、Z80にて追加されたブロック転送命令やインデックスレジスタ命令は、一連の処理に必要なプログラムコードのバイト数を節約できる反面、他の命令で代用する場合よりも所要クロック数が増大するといったデメリットもあり、命令のメモリ空間上の占有量と処理速度とのトレードオフの関係にあった。
またZ80は、同時期に新規に開発された他社製の8bitCPUと比較すると、相対ジャンプは可能であるもののジャンプ先の範囲が狭いなどリロケータブルな構成をとりづらく、バイナリ化したコードをリロケータブルに配置して動作させるドライバやデバッガ、オペレーティングシステム等の環境を作るには不向きとされた。リロケータブルでない一般的なバイナリは、配置アドレスを変更する度に再コンパイルや再リンクが必要となった。またアドレス参照時のオフセットも汎用レジスタ使用時には指定できず、インデックスレジスタ使用のオフセット指定も-128〜0〜127の範囲で制限されるため、C言語のポインタとの相性がよくない面があった。
アドレッシングモードが少ないこともあり、オペコードおよび命令フォーマットを暗記して、直接機械語を記述することも、さほど難しいものでもなかった。
A,B,C,D,E,H,Lは8080の同名レジスタと同じ機能を持つ。
Fは8080上位互換のフラグレジスタである。
Rはリフレッシュカウンタで、オリジナルのZ80では下位7ビットが変化し、読み出した際の最上位ビットの初期値は不定である。書き込んだ場合、最上位ビットが保存され、読み出すと最上位ビットは書き込んだ値が得られる。周辺LSI統合CPU・上位互換CPUでは、8ビット全部使用し、8ビット全部が変化し書き込んでも最上位ビットが保存されないものもあるほか、8ビット全部が変化せず書き込んだ値が保存されるものもある。
ここではZ80で追加された命令のみ示す。8080からある命令についてはIntel 8080#命令セットを参照。また、IXとIYについては同等の命令が存在するが、ここではIXのみを示す。
8086のストリング命令、80186/V30のI/Oストリング命令に相当する。LDIRが最もよく使われる。
Z80には8080と同じくメモリアドレスとは別に0からFF(255)までのI/Oポートアドレスを持っていた。ポートアドレスはメインメモリーのアドレスデコーダーを流用していたのか、アドレスバスの下位8ビットに出力されたが、上位8ビットにも同時に値が出力される仕様になっていた。この値にはI/OアドレスをCレジスタで指定する命令の場合はBレジスタ、それ以外の命令はAレジスタの値が用いられる。
この仕様を利用するとI/Oポート空間を16ビットアドレスで取り扱うことができ、VRAMをここに割り当てることで、メインメモリーがVRAMによって圧迫されることを防ぐことができる。そのような構成をとった日本製パソコンには、シャープのX1、ソニーのSMC-777、BUBCOM80などがある。シャープMZ-1500ではオプションのRAMファイル（MZ-1R18、容量64KB）のアクセスにこの仕様を使用している。
しかし、通常に16bitアドレスをデコードしてI/Oのハードを構成してしまうと、アドレス指定にBCレジスタを指定しないOUT命令の時にアドレスバス上位8ビットにはAレジスタの内容が出力されてしまうため、アドレス指定にBCレジスタを指定しないOUT命令を用いることが出来なくなってしまう。そこで、SONYのSMC-70では、I/Oアドレスの上位8bitを下位に、下位8ビットを上位にアドレスデコードした。こうして、多くのI/Oアドレスの割り付けが必要なところでは上位8ビット・下位8ビット両方をデコードしてBCレジスタアドレシングのOUT命令でアクセス、他のI/Oアドレスでは元の下位アドレスのみをデコードしてデバイスに割り付けることにより、通常のOUT命令を使用できるようにした。
なお、ブロック入出力命令の場合はBレジスタをデクリメントするため、16ビットアドレスとしては使用しにくい。逆にこれを利用することにより残り回数を周辺デバイスなどが知ることができる。ただし、出力の場合は処理の順番はアドレス出力よりもBレジスタのデクリメントが先のため、アドレスの上位8ビットを利用する場合は1小さい値が出力されることに留意する必要がある。なお、入力の場合はアドレス出力が先である。
セカンド・ソース契約に基づいてピンコンパチブルな互換製品が他社で生産された。こうした製品には、シャープの「LH0080」モステックの「MK3880」などがある。一方、日本電気(NEC)が独自に互換性のある「μPD780」を出荷したことに対し、ザイログはこれをチップ著作権侵害として訴訟を起こしたが、最終的には両者は和解して製造販売が継続された。
もともとはNMOSプロセスで製造されたが、一部のセカンド・ソースの製造者からは、NEC「μPD70008」、シャープ「LH5080」、東芝「TMPZ84C00」など、独自にCMOSプロセス化し消費電力の低減を図った製品も出荷されている。
また、2002年にシャープがシステム液晶のデモンストレーションとしてガラス基板上にZ80を形成し、MZ-80CのCPUと交換し動作させた。
この他にも東欧諸国で、例えば東ドイツのU880、ルーマニアのMMN80CPUや、ソ連のなど、ライセンスによらないクローン製品があった。
ナショナル・セミコンダクターからは、CMOS化とともに、インテル8085のようにアドレスバスの下位とデータバスとをマルチプレックスさせ、Z80とソフトウェアの互換性を持つ「NSC800」が製造された。ただし8085とはピン配置が異なり、置き換えだけでの移行はできない。
現在でも制御、組込用として、メモリおよび周辺機器の制御用回路を単一のパッケージに集積したLSIが製造されており、ASICのIPコアとしてZ80の互換プロセッサを用意するデバイスメーカーも多い。Z80 IPコアは、本家の「ALUが4bitのため、多くの演算で複数クロックを必要とする」「レジスタがダイナミック動作をするため、クロックを停止できない」「LDx、LDxRのような繰り返し実行する命令やインデックスレジスタを使う命令等、組み込み用途では不要な複雑な命令がある」といった欠点を解消した物も提供されている。
以下にZ80互換のCPUのうち、ザイログ以外の会社で開発された上位互換性を持つものを示す。高速化を図ったものや、周辺デバイスを集積したものである。
ザイログ自身の開発による上位互換CPUを以下に示す。
Z80は、8080とバイナリレベルで互換性があり、そのDOSであるCP/M、及びCP/M上で動作する各種のソフトウェアが利用可能である。以下はCP/M上の動作を前提に供給されたものの一部である。
